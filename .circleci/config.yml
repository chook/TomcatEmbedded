version: 2.1

orbs:
  maven: circleci/maven@1.1.1
  docker: circleci/docker@1.5.0
jobs:
  build:
    docker:
      - image: circleci/openjdk:stretch
    steps:
      - checkout
      - run: mvn -Dmaven.test.skip=true package
      - save_cache:
            paths:
              - ~/.m2
            key: v1-dependencies-{{ checksum "pom.xml" }}
      - store_artifacts:
          path: target/TomcatEmbedded.war
      - store_artifacts:
          path: target/dependency/webapp-runner.jar
  unit-tests:
    docker:
      - image: cimg/openjdk:15.0.1-node
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }} # appends cache key with a hash of pom.xml file
            - v1-dependencies- # fallback in case previous cache key is not found
      - run: mvn test
      - run:
          name: Save test results
          command: |
            mkdir -p ~/test-results/junit/
            find . -type f -regex ".*/target/surefire-reports/.*xml" -exec cp {} ~/test-results/junit/ \;
          when: always
      - store_test_results:
          path: ~/test-results/junit
      - store_artifacts:
          path: ~/test-results/junit
  up9-tap-and-learn:
    docker:
      - image: cimg/openjdk:15.0.1-node
    steps:
      - setup_remote_docker:
          version: 19.03.13
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }} # appends cache key with a hash of pom.xml file
            - v1-dependencies- # fallback in case previous cache key is not found
      - run: 
          name: "[UP9] Install latest CLI"
          command: sudo npm i -g up9
      - run: 
          name: "[UP9] Authenticate"
          command: up9 auth:login --client-id=$UP9_CLIENT_ID --client-secret=$UP9_CLIENT_SECRET --env=$UP9_ENV
      - run: 
          name: Build server
          command: |
            mvn -DskipTests=true package jib:dockerBuild
            up9 tap:create-docker-compose ch.$CIRCLE_JOB-$CIRCLE_BUILD_NUM --agent-name=$CIRCLE_JOB-$CIRCLE_BUILD_NUM
      - run: 
          name: Run test
          command: |
            docker-compose -f docker-compose.yml -f docker-compose-up9.yml up -d
            sleep 30
      - run: 
          name: Stop test
          command: |
            docker-compose down

      # docker run -d --name tomcat-embedded chook/tomcat-embedded
      #docker ps
      #sleep 3
      #docker run --network container:tomcat-embedded

  deploy:
    docker:
      - image: circleci/openjdk:stretch
    steps:
      - run: echo "Deployed"          
  up9-integration-test:
    docker:
      - image: gcr.io/up9-docker-hub/circleci/cimg/up9:latest #circleci/node:latest #node:12-alpine
    steps:
      - setup_remote_docker:
          version: 19.03.13
      - run: 
          name: "[UP9] Install latest CLI"
          command: sudo npm i -g up9
      - run: 
          name: "[UP9] Authenticate"
          command: up9 auth:login --client-id=$UP9_CLIENT_ID --client-secret=$UP9_CLIENT_SECRET --env=$UP9_ENV
      - run:
          name: "[UP9] Environment setup"
          command: |
            mkdir -p ~/test-results/up9
            cd ~/test-results/up9
            tab="  "
            echo "services:" > services.yaml
            echo "$tab"TARGET_CARTS: >> services.yaml
            echo "$tab""$tab"remoteUrl: http://google.com >> services.yaml
      # mkdir -p ~/.config/up9/tests/$UP9_WORKSPACE
      # - run:
      #     name: "[UP9] Fetch containers"
      #     command: "docker pull gcr.io/up9-docker-hub/test-runner/develop:latest"
      - run: 
          name: "[UP9] Fetch and run tests"
          command: |
            cd ~/test-results/up9
            up9 test:run-local $UP9_WORKSPACE $UP9_SUBSYSTEM --services-config-file=services.yaml --junit
            cat junit.*.xml > up9-results2.xml
            sed 's/up9.tests.ch.weavesock.010321.carts.Tests_carts/https:\/\/stg.testr.io\/someOrgId123\/workspaces\/ch.weavesock.010321\/latest\/systems\/carts\/tests\/tests\?contract=3c76e19c-e05a-4748-a6e9-60d8f38f095d&run=last&testsTab=reports/g' up9-results2.xml > up9-results.xml
            rm junit.*
            rm up9-results2.xml
          #awk 'NR==2 {print "<properties><property name=\"up9-link\" value=\"https://up9.app\"/></properties>"} 1' junit.*.xml > up9-results.xml
            
      - store_test_results:
          path: ~/test-results/up9
      - store_artifacts:
          path: ~/test-results/up9
workflows:
  version: 2

  build-then-test:
    jobs:
      - build
      - unit-tests:
          requires:
            - build
      - up9-tap-and-learn:
          requires:
            - unit-tests
      - deploy:
          requires:
            - build
            - unit-tests
      - up9-integration-test:
          requires:
            - unit-tests
            - deploy